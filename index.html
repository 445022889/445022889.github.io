<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube频道封面图生成器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5.0.0/dist/full.css" rel="stylesheet" type="text/css" />
    <style>
        .preview-container {
            background-color: var(--b2);
            border-radius: 1rem;
            padding: 1rem;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #preview-canvas {
            max-width: 100%;
            height: auto;
        }
    </style>
</head>
<body class="min-h-screen bg-base-200">
    <div class="navbar bg-base-100 shadow-lg">
        <div class="flex-1">
            <a class="btn btn-ghost normal-case text-xl">YouTube封面生成器</a>
        </div>
        <div class="flex-none">
            <label class="swap swap-rotate">
                <input type="checkbox" class="theme-controller" value="dark" />
                <svg class="swap-on fill-current w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5.64,17l-.71.71a1,1,0,0,0,0,1.41,1,1,0,0,0,1.41,0l.71-.71A1,1,0,0,0,5.64,17ZM5,12a1,1,0,0,0-1-1H3a1,1,0,0,0,0,2H4A1,1,0,0,0,5,12Zm7-7a1,1,0,0,0,1-1V3a1,1,0,0,0-2,0V4A1,1,0,0,0,12,5ZM5.64,7.05a1,1,0,0,0,.7.29,1,1,0,0,0,.71-.29,1,1,0,0,0,0-1.41l-.71-.71A1,1,0,0,0,4.93,6.34Zm12,.29a1,1,0,0,0,.7-.29l.71-.71a1,1,0,1,0-1.41-1.41L17,5.64a1,1,0,0,0,0,1.41A1,1,0,0,0,17.66,7.34ZM21,11H20a1,1,0,0,0,0,2h1a1,1,0,0,0,0-2Zm-9,8a1,1,0,0,0-1,1v1a1,1,0,0,0,2,0V20A1,1,0,0,0,12,19ZM18.36,17A1,1,0,0,0,17,18.36l.71.71a1,1,0,0,0,1.41,0,1,1,0,0,0,0-1.41ZM12,6.5A5.5,5.5,0,1,0,17.5,12,5.51,5.51,0,0,0,12,6.5Zm0,9A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z"/></svg>
                <svg class="swap-off fill-current w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21.64,13a1,1,0,0,0-1.05-.14,8.05,8.05,0,0,1-3.37.73A8.15,8.15,0,0,1,9.08,5.49a8.59,8.59,0,0,1,.25-2A1,1,0,0,0,8,2.36,10.14,10.14,0,1,0,22,14.05,1,1,0,0,0,21.64,13Zm-9.5,6.69A8.14,8.14,0,0,1,7.08,5.22v.27A10.15,10.15,0,0,0,17.22,15.63a9.79,9.79,0,0,0,2.1-.22A8.11,8.11,0,0,1,12.14,19.73Z"/></svg>
            </label>
        </div>
    </div>

    <div class="container mx-auto p-4 max-w-7xl">
        <div class="flex flex-col lg:flex-row gap-4">
            <!-- 控制面板 -->
            <div class="w-full lg:w-1/2">
                <div class="card bg-base-100 shadow-xl">
                    <div class="card-body">
                        <h2 class="card-title text-lg">基本信息</h2>
                        
                        <!-- 头像上传 -->
                        <div class="form-control w-full">
                            <label class="label">
                                <span class="label-text">头像</span>
                            </label>
                            <div class="flex items-center gap-4">
                                <div class="avatar" id="avatar-preview" style="display: none;">
                                    <div class="w-24 rounded-full">
                                        <img id="avatar-img" src="" alt="头像预览">
                                    </div>
                                </div>
                                <input type="file" id="avatar-input" accept="image/*" class="file-input file-input-bordered w-full max-w-xs" />
                            </div>
                        </div>

                        <!-- 昵称输入 -->
                        <div class="form-control w-full">
                            <label class="label">
                                <span class="label-text">昵称</span>
                            </label>
                            <input type="text" id="nickname-input" placeholder="请输入频道昵称" class="input input-bordered w-full" />
                        </div>

                        <!-- 图标上传区域 -->
                        <div class="form-control w-full">
                            <label class="label">
                                <span class="label-text">图标</span>
                            </label>
                            <div class="flex flex-wrap gap-2 p-2 border-2 border-dashed rounded-lg min-h-[100px]" id="icons-container"></div>
                            <input type="file" id="icon-input" accept="image/*" multiple class="file-input file-input-bordered w-full mt-2" />
                            <div class="text-sm text-base-content/70 mt-1">支持多选或拖拽上传</div>
                        </div>

                        <!-- 文章内容 -->
                        <div class="form-control w-full">
                            <label class="label">
                                <span class="label-text">文章内容</span>
                            </label>
                            <textarea id="content-input" class="textarea textarea-bordered h-24" placeholder="请输入文章内容"></textarea>
                        </div>
                    </div>
                </div>

                <!-- 样式设置 -->
                <div class="card bg-base-100 shadow-xl mt-4">
                    <div class="card-body">
                        <h2 class="card-title text-lg">样式设置</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">文字大小</span>
                                </label>
                                <input type="range" id="text-size" min="12" max="54" value="54" class="range" disabled />
                                <div class="text-center mt-1" id="text-size-value">54px</div>
                            </div>

                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">文字颜色</span>
                                </label>
                                <input type="color" id="text-color" class="w-full h-12 rounded-lg" value="#000000">
                            </div>

                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">背景颜色</span>
                                </label>
                                <input type="color" id="bg-color" class="w-full h-12 rounded-lg" value="#FFFFFF">
                            </div>

                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">字体</span>
                                </label>
                                <select id="font-family" class="select select-bordered w-full">
                                    <option value="Arial">Arial</option>
                                    <option value="'Microsoft YaHei'">微软雅黑</option>
                                    <option value="'SimHei'">黑体</option>
                                    <option value="'SimSun'">宋体</option>
                                    <option value="'KaiTi'">楷体</option>
                                    <option value="'Times New Roman'">Times New Roman</option>
                                    <option value="'Courier New'">Courier New</option>
                                    <option value="'Georgia'">Georgia</option>
                                </select>
                            </div>

                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">边框圆角</span>
                                </label>
                                <input type="range" id="border-radius" min="0" max="20" value="5" class="range" />
                                <div class="text-center mt-1" id="border-radius-value">5px</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 预览区域 -->
            <div class="w-full lg:w-1/2">
                <div class="card bg-base-100 shadow-xl">
                    <div class="card-body">
                        <h2 class="card-title text-lg">预览</h2>
                        <div class="preview-container">
                            <canvas id="preview-canvas"></canvas>
                        </div>
                        <div class="card-actions justify-end mt-4">
                            <button id="download-btn" class="btn btn-primary">保存封面图</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 获取DOM元素
        const avatarInput = document.getElementById('avatar-input');
        const avatarPreview = document.getElementById('avatar-preview');
        const avatarImg = document.getElementById('avatar-img');
        const nicknameInput = document.getElementById('nickname-input');
        const iconInput = document.getElementById('icon-input');
        const iconsContainer = document.getElementById('icons-container');
        const contentInput = document.getElementById('content-input');
        const textSize = document.getElementById('text-size');
        const textSizeValue = document.getElementById('text-size-value');
        const textColor = document.getElementById('text-color');
        const bgColor = document.getElementById('bg-color');
        const fontFamily = document.getElementById('font-family');
        const borderRadius = document.getElementById('border-radius');
        const borderRadiusValue = document.getElementById('border-radius-value');
        const previewCanvas = document.getElementById('preview-canvas');
        const downloadBtn = document.getElementById('download-btn');
        const themeController = document.querySelector('.theme-controller');

        // 主题切换
        themeController.addEventListener('change', (e) => {
            document.documentElement.setAttribute('data-theme', e.target.checked ? 'dark' : 'light');
        });

        // 设置Canvas尺寸
        const canvas = previewCanvas;
        const ctx = canvas.getContext('2d');
        canvas.width = 1327;

        // 头像图片对象
        let avatarImage = null;

        // 图标数组
        let icons = [];

        // 头像预览
        avatarInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    avatarImg.src = event.target.result;
                    avatarPreview.style.display = 'block';
                    
                    const img = new Image();
                    img.onload = function() {
                        avatarImage = img;
                        updatePreview();
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // 批量添加图标
        iconInput.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            files.forEach(file => addIcon(file));
        });

        // 拖拽上传图标
        iconsContainer.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            iconsContainer.classList.add('border-2', 'border-dashed', 'border-primary');
        });

        iconsContainer.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            iconsContainer.classList.remove('border-2', 'border-dashed', 'border-primary');
        });

        iconsContainer.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            iconsContainer.classList.remove('border-2', 'border-dashed', 'border-primary');
            
            const files = Array.from(e.dataTransfer.files);
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    addIcon(file);
                }
            });
        });

        // 添加图标
        function addIcon(file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const iconImage = new Image();
                iconImage.onload = function() {
                    const iconId = 'icon-' + Date.now();
                    icons.push({
                        id: iconId,
                        image: iconImage
                    });

                    // 创建图标预览元素
                    const iconItem = document.createElement('div');
                    iconItem.className = 'badge badge-lg gap-2 cursor-move';
                    iconItem.dataset.id = iconId;
                    iconItem.draggable = true;

                    const iconPreview = document.createElement('img');
                    iconPreview.className = 'w-4 h-4 object-contain';
                    iconPreview.src = event.target.result;

                    const iconRemove = document.createElement('span');
                    iconRemove.className = 'cursor-pointer text-error';
                    iconRemove.innerHTML = '×';
                    iconRemove.onclick = function() {
                        removeIcon(iconId);
                    };

                    iconItem.appendChild(iconPreview);
                    iconItem.appendChild(iconRemove);
                    iconsContainer.appendChild(iconItem);

                    // 添加拖拽事件
                    iconItem.addEventListener('dragstart', handleDragStart);
                    iconItem.addEventListener('dragover', handleDragOver);
                    iconItem.addEventListener('drop', handleDrop);
                    iconItem.addEventListener('dragend', handleDragEnd);

                    updatePreview();
                };
                iconImage.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        // 移除图标
        function removeIcon(iconId) {
            icons = icons.filter(icon => icon.id !== iconId);
            const iconElement = document.querySelector(`[data-id="${iconId}"]`);
            if (iconElement) {
                iconElement.remove();
            }
            updatePreview();
        }

        // 拖拽排序相关变量
        let dragSrcEl = null;

        function handleDragStart(e) {
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
            this.classList.add('opacity-50');
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDrop(e) {
            e.stopPropagation();
            if (dragSrcEl !== this) {
                const allIcons = [...iconsContainer.querySelectorAll('[data-id]')];
                const draggedIndex = allIcons.indexOf(dragSrcEl);
                const droppedIndex = allIcons.indexOf(this);

                // 更新DOM
                if (draggedIndex < droppedIndex) {
                    this.parentNode.insertBefore(dragSrcEl, this.nextSibling);
                } else {
                    this.parentNode.insertBefore(dragSrcEl, this);
                }

                // 更新图标数组
                const temp = icons[draggedIndex];
                icons.splice(draggedIndex, 1);
                icons.splice(droppedIndex, 0, temp);

                updatePreview();
            }
            return false;
        }

        function handleDragEnd() {
            this.classList.remove('opacity-50');
        }

        // 更新预览
        function updatePreview() {
            // 计算画布高度（根据内容自适应）
            const content = contentInput.value || 'My mother gave me a Chanel bag. My roommate was so jealous that she kept annoying me part 2';
            const fontSize = 54; // 固定文章字号为54px
            const lineHeight = fontSize * 1.2;
            
            // 临时设置字体以计算文本高度
            ctx.font = `bold 54px ${fontFamily.value}`;
            
            // 文本换行处理计算高度
            const leftPadding = 100; // 左侧边距
            const rightPadding = 100; // 右侧边距
            const maxWidth = canvas.width - (leftPadding + rightPadding); // 确保左右边距相等
            const words = content.split(' ');
            let line = '';
            // 初始文本Y位置 - 调整为头像底部(160)加上一个图标高度(24px)
            let y = 160 + 24; 
            let textHeight = 0;
            
            for (let i = 0; i < words.length; i++) {
                const testLine = line + words[i] + ' ';
                const metrics = ctx.measureText(testLine);
                const testWidth = metrics.width;
                
                if (testWidth > maxWidth && i > 0) {
                    line = words[i] + ' ';
                    y += lineHeight;
                    textHeight += lineHeight;
                } else {
                    line = testLine;
                }
            }
            
            // 计算总高度（头部空间 + 文本高度 + 底部空间）
            const totalHeight = Math.max(400, 200 + textHeight + 100);
            canvas.height = totalHeight;
            
            // 清空画布
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 绘制背景
            ctx.fillStyle = bgColor.value;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 绘制圆角矩形背景
            const borderRadiusVal = parseInt(borderRadius.value);
            const rectWidth = canvas.width - 40;
            const rectHeight = canvas.height - 40;
            const rectX = 20;
            const rectY = 20;
            
            // 绘制圆角矩形
            ctx.save();
            ctx.beginPath();
            ctx.moveTo(rectX + borderRadiusVal, rectY);
            ctx.lineTo(rectX + rectWidth - borderRadiusVal, rectY);
            ctx.quadraticCurveTo(rectX + rectWidth, rectY, rectX + rectWidth, rectY + borderRadiusVal);
            ctx.lineTo(rectX + rectWidth, rectY + rectHeight - borderRadiusVal);
            ctx.quadraticCurveTo(rectX + rectWidth, rectY + rectHeight, rectX + rectWidth - borderRadiusVal, rectY + rectHeight);
            ctx.lineTo(rectX + borderRadiusVal, rectY + rectHeight);
            ctx.quadraticCurveTo(rectX, rectY + rectHeight, rectX, rectY + rectHeight - borderRadiusVal);
            ctx.lineTo(rectX, rectY + borderRadiusVal);
            ctx.quadraticCurveTo(rectX, rectY, rectX + borderRadiusVal, rectY);
            ctx.closePath();
            ctx.fillStyle = bgColor.value;
            ctx.fill();
            ctx.restore();
            
            // 绘制头像（如果有）
            if (avatarImage) {
                const avatarSize = 108;
                const avatarX = 60;
                const avatarY = 60;
                
                // 创建圆形头像
                ctx.save();
                ctx.beginPath();
                ctx.arc(avatarX + avatarSize / 2, avatarY + avatarSize / 2, avatarSize / 2, 0, Math.PI * 2);
                ctx.closePath();
                ctx.clip();
                
                // 保持图片原始比例
                const aspectRatio = avatarImage.width / avatarImage.height;
                let drawWidth = avatarSize;
                let drawHeight = avatarSize;
                let offsetX = 0;
                let offsetY = 0;
                
                if (aspectRatio > 1) {
                    // 宽图
                    drawHeight = avatarSize / aspectRatio;
                    offsetY = (avatarSize - drawHeight) / 2;
                } else if (aspectRatio < 1) {
                    // 高图
                    drawWidth = avatarSize * aspectRatio;
                    offsetX = (avatarSize - drawWidth) / 2;
                }
                
                ctx.drawImage(avatarImage, avatarX + offsetX, avatarY + offsetY, drawWidth, drawHeight);
                ctx.restore();
            }
            
            // 绘制昵称
            const nickname = nicknameInput.value || '频道名称';
            ctx.font = `bold 38px ${fontFamily.value}`;
            ctx.fillStyle = textColor.value;
            ctx.textBaseline = 'top';
            
            // 计算昵称垂直居中位置 - 头像中心点Y坐标为(60 + 108/2 = 114)
            const nicknameY = 100 - 38/2; // 头像中心点减去昵称字体高度的一半
            const c170 = 190;
            // 绘制昵称 - 减少与头像的距离
            ctx.fillText(nickname, c170, nicknameY);
            
            // 添加认证标记（蓝色勾号）
            ctx.fillStyle = '#1DA1F2';
            ctx.beginPath();
            const nicknameWidth = ctx.measureText(nickname).width;
            ctx.arc(c170 + nicknameWidth + 15, nicknameY + 19, 10, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#FFFFFF';
            ctx.font = `bold 14px ${fontFamily.value}`;
            ctx.fillText('✓', c170 + nicknameWidth + 10, nicknameY + 15);
            
            // 绘制图标
            let iconX = c170;
            // 图标垂直居中位置 - 头像中心点Y坐标为114，图标位于昵称下方
            const iconY = nicknameY + 38 + 5; // 昵称Y位置 + 昵称高度 + 间距
            const iconSize = 36;
            const iconGap = 12;
            
            for (let i = 0; i < icons.length; i++) {
                if (icons[i].image) {
                    // 保持图标原始比例
                    const icon = icons[i].image;
                    const iconAspectRatio = icon.width / icon.height;
                    let iconDrawWidth = iconSize;
                    let iconDrawHeight = iconSize;
                    let iconOffsetX = 0;
                    let iconOffsetY = 0;
                    
                    if (iconAspectRatio > 1) {
                        // 宽图标
                        iconDrawHeight = iconSize / iconAspectRatio;
                        iconOffsetY = (iconSize - iconDrawHeight) / 2;
                    } else if (iconAspectRatio < 1) {
                        // 高图标
                        iconDrawWidth = iconSize * iconAspectRatio;
                        iconOffsetX = (iconSize - iconDrawWidth) / 2;
                    }
                    
                    ctx.drawImage(icon, iconX + iconOffsetX, iconY + iconOffsetY, iconDrawWidth, iconDrawHeight);
                    iconX += iconSize + iconGap;
                }
            }
            
            // 绘制内容
            ctx.font = `bold 54px ${fontFamily.value}`; // 固定文章字号为54px
            ctx.fillStyle = textColor.value;
            
            // 文本换行处理
            line = '';
            // 计算文章内容的起始位置：头像底部(60+108=168)加上适当间距
            y = 168 + 30;
            
            for (let i = 0; i < words.length; i++) {
                const testLine = line + words[i] + ' ';
                const metrics = ctx.measureText(testLine);
                const testWidth = metrics.width;
                
                if (testWidth > maxWidth && i > 0) {
                    ctx.fillText(line, leftPadding, y);
                    line = words[i] + ' ';
                    y += lineHeight;
                } else {
                    line = testLine;
                }
            }
            ctx.fillText(line, leftPadding, y);
        }

        // 绑定事件监听
        [nicknameInput, contentInput, textSize, textColor, bgColor, fontFamily, borderRadius].forEach(el => {
            el.addEventListener('input', updatePreview);
        });

        // 更新边框圆角值显示
        borderRadius.addEventListener('input', function() {
            borderRadiusValue.textContent = this.value + 'px';
        });

        // 下载按钮点击事件
        downloadBtn.addEventListener('click', function() {
            const link = document.createElement('a');
            link.download = 'youtube-cover.png';
            link.href = canvas.toDataURL();
            link.click();
        });

        // 初始化预览
        updatePreview();
    </script>
</body>
</html>
